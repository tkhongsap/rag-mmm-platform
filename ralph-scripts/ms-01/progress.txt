## Codebase Patterns
- For dependency and lint workflows in this repo, activate the project virtualenv first (`source .venv/bin/activate`) because system Python may enforce PEP 668 and block global `pip install`.
- For new generated `data/` outputs, add ignore rules in `.gitignore` but keep `!data/**/.gitkeep` so placeholder files remain tracked.
- `data/generators/generate_all.py` expects module `data.generators.aggregate_mmm` with `aggregate_mmm_data`; keep that import path stable even if aggregation logic is implemented in `validators.py`.
- In `generate_all.py` summary spend verification, aggregate only `data/raw` CSVs, skip `competitor_spend.csv`, and use exact column match `c.lower() == "spend"` to avoid inflated totals from non-channel spend fields.

## 2026-02-20 09:58:07 +0700 - US-001
- Implemented missing dependency declarations in `requirements.txt`: `Pillow>=10.0.0`, `qdrant-client>=1.9.0`, and `llama-index-vector-stores-qdrant>=0.3.0`.
- Files changed: `requirements.txt`, `CLAUDE.md`, `ralph-scripts/ms-01/prd.json`, `ralph-scripts/ms-01/progress.txt`.
- **Learnings for future iterations:**
  - Patterns discovered: use the project virtualenv for dependency and check commands (`source .venv/bin/activate && ...`).
  - Gotchas encountered: system-level `pip install -r requirements.txt` fails in this environment with PEP 668 `externally-managed-environment`.
  - Useful context: this storyâ€™s quality gate is `make lint` (py_compile checks), and it passed after the dependency update.
---
## 2026-02-20 10:01:07 +0700 - US-002
- Implemented `.gitignore` updates for generated artifacts by adding `data/assets/*`, `data/qdrant_db/`, and `data/index/` under the data directories section while preserving `!data/**/.gitkeep`.
- Files changed: `.gitignore`, `CLAUDE.md`, `ralph-scripts/ms-01/prd.json`, `ralph-scripts/ms-01/progress.txt`.
- **Learnings for future iterations:**
  - Patterns discovered: when adding ignored generated data folders, keep ignore entries grouped under the data section and retain the shared `.gitkeep` exception.
  - Gotchas encountered: `.gitignore` does not remove already tracked files; it only prevents new untracked artifacts from appearing in status.
  - Useful context: `source .venv/bin/activate && make lint` remains the required quality gate in this repo and passed for this update.
---
## 2026-02-20 10:08:35 +0700 - US-003
- Implemented `data/generators/aggregate_mmm.py` as a compatibility module that re-exports `aggregate_mmm_data` from `data/generators/validators.py`, so `generate_all.py` can import and run the MMM aggregation step.
- Verified `importlib.import_module('data.generators.aggregate_mmm')` succeeds, ran `python3 data/generators/generate_all.py` (aggregation step now reports `OK`, all validators pass), and confirmed `data/mmm/model_ready.csv`, `data/mmm/weekly_channel_spend.csv`, and `data/mmm/weekly_sales.csv` each contain 52 rows.
- Files changed: `data/generators/aggregate_mmm.py`, `CLAUDE.md`, `ralph-scripts/ms-01/prd.json`, `ralph-scripts/ms-01/progress.txt`.
- **Learnings for future iterations:**
  - Patterns discovered: keep the orchestrator-facing import path (`data.generators.aggregate_mmm`) separate from implementation files to avoid runtime import skips.
  - Gotchas encountered: `python3 data/generators/generate_all.py` is CPU-intensive and may run for several minutes before output flushes in non-interactive execution.
  - Useful context: after this fix, MMM aggregation completes and writes 52-week outputs to `data/mmm/` as expected.
---
## 2026-02-20 10:15:46 +0700 - US-004
- Implemented spend verification fixes in `data/generators/generate_all.py`: scan only `data/raw`, skip `competitor_spend.csv`, and match spend columns with exact filter `c.lower() == "spend"`.
- Verified with `python3 data/generators/generate_all.py` that spend verification reports `Deviation: 0.0% [OK]` and validator output reports `ALL VALIDATIONS PASSED`; quality gate `source .venv/bin/activate && make lint` also passed.
- Files changed: `data/generators/generate_all.py`, `CLAUDE.md`, `ralph-scripts/ms-01/prd.json`, `ralph-scripts/ms-01/progress.txt`.
- **Learnings for future iterations:**
  - Patterns discovered: spend verification should intentionally avoid scanning aggregated MMM outputs to prevent double counting the same channel spend.
  - Gotchas encountered: broad substring filters (e.g., matching both `spend` and `gbp`) can capture non-channel spend fields and distort budget deviation checks.
  - Useful context: full generator runtime is around 4 minutes in this environment, and output may appear only at process completion due buffering.
---
